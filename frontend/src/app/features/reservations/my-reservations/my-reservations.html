<div class="my-reservations-container">
  
  <!-- Header -->
  <div class="header">
    <h1>
      <mat-icon>bookmark</mat-icon>
      Mes réservations
    </h1>
    <p class="subtitle">Suivez l'état de vos réservations</p>
  </div>

  <!-- Loader -->
  <div *ngIf="loading()" class="loader-container">
    <mat-spinner></mat-spinner>
    <p>Chargement de vos réservations...</p>
  </div>

  <!-- Contenu principal -->
  <div *ngIf="!loading()">

    <!-- Onglets de filtres -->
    <mat-tab-group 
      mat-stretch-tabs="false" 
      (selectedIndexChange)="filterByStatus(statuses[$event].value)"
      class="filter-tabs">
      
      <mat-tab *ngFor="let status of statuses" [label]="status.label + ' (' + status.count + ')'">
      </mat-tab>
      
    </mat-tab-group>

    <!-- Liste des réservations -->
    <div class="reservations-grid">
      
      <!-- Aucune réservation -->
      <div *ngIf="filteredReservations().length === 0" class="no-reservations">
        <mat-icon>inbox</mat-icon>
        <h2>Aucune réservation</h2>
        <p>Vous n'avez pas encore de réservation{{ selectedStatus() !== 'all' ? ' avec ce statut' : '' }}.</p>
        <button mat-raised-button color="primary" routerLink="/donations">
          <mat-icon>search</mat-icon>
          Découvrir les donations
        </button>
      </div>

      <!-- Cartes de réservations -->
      <mat-card *ngFor="let reservation of filteredReservations()" class="reservation-card">
        
        <!-- En-tête avec statut -->
        <div class="card-header">
          <mat-chip [color]="getStatusColor(reservation.status)" highlighted>
            <mat-icon>{{ getStatusIcon(reservation.status) }}</mat-icon>
            {{ getStatusLabel(reservation.status) }}
          </mat-chip>
          
          <button mat-icon-button [matMenuTriggerFor]="menu">
            <mat-icon>more_vert</mat-icon>
          </button>
          
          <mat-menu #menu="matMenu">
            <button mat-menu-item [routerLink]="['/reservations', reservation._id]">
              <mat-icon>visibility</mat-icon>
              Voir les détails
            </button>
            <button 
              mat-menu-item 
              *ngIf="canCancel(reservation)"
              (click)="cancelReservation(reservation._id)">
              <mat-icon>cancel</mat-icon>
              Annuler
            </button>
          </mat-menu>
        </div>

        <!-- Image et infos de la donation -->
        <div class="card-content">
          
          <div class="donation-image">
            <img 
              *ngIf="reservation.donation?.images?.length > 0; else noImage"
              [src]="reservation.donation.images[0]" 
              [alt]="reservation.donation.title">
            
            <ng-template #noImage>
              <div class="no-image-placeholder">
                <mat-icon>image_not_supported</mat-icon>
              </div>
            </ng-template>
          </div>

          <div class="donation-info">
            <h3>
              <span class="category-icon">
                {{ getCategoryIcon(reservation.donation?.category) }}
              </span>
              {{ reservation.donation?.title }}
            </h3>

            <div class="info-item">
              <mat-icon>category</mat-icon>
              <span>{{ reservation.donation?.category }}</span>
            </div>

            <div class="info-item">
              <mat-icon>shopping_basket</mat-icon>
              <span>{{ reservation.donation?.quantity }} {{ reservation.donation?.unit }}</span>
            </div>

            <div class="info-item">
              <mat-icon>event</mat-icon>
              <span>Retrait: {{ formatDate(reservation.pickupDate) }}</span>
            </div>

            <div class="info-item">
              <mat-icon>location_on</mat-icon>
              <span>{{ reservation.donation?.pickupLocation?.address }}</span>
            </div>

            <!-- Donateur -->
            <div class="donor-info">
              <img 
                [src]="reservation.donor?.avatar || 'assets/images/default-avatar.png'"
                class="donor-avatar">
              <div>
                <strong>{{ reservation.donor?.firstName }} {{ reservation.donor?.lastName }}</strong>
                <p *ngIf="reservation.donor?.phone">
                  <mat-icon>phone</mat-icon>
                  {{ reservation.donor.phone }}
                </p>
              </div>
            </div>

            <!-- Message -->
            <div *ngIf="reservation.message" class="message">
              <mat-icon>message</mat-icon>
              <p>{{ reservation.message }}</p>
            </div>
          </div>

        </div>

        <!-- Actions -->
        <mat-card-actions>
          <button 
            mat-button 
            color="primary"
            [routerLink]="['/reservations', reservation._id]">
            <mat-icon>visibility</mat-icon>
            Voir les détails
          </button>
          
          <button 
            mat-button 
            color="warn"
            *ngIf="canCancel(reservation)"
            (click)="cancelReservation(reservation._id)">
            <mat-icon>cancel</mat-icon>
            Annuler
          </button>
        </mat-card-actions>

      </mat-card>

    </div>

  </div>

</div>